<!DOCTYPE html>
<html lang="no">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sett nytt passord – SBS</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <div class="header-content">
        <img src="logo-placeholder.png" alt="SBS Logo" />
        <nav id="main-nav">
          <a href="index.html" class="nav-link"> Hjem </a>
          <a href="sanger.html" class="nav-link"> Sanger </a>
          <a href="betaling.html" class="nav-link"> Betaling </a>
          <a href="Inlogging.html" class="nav-link auth-link"> Logg inn </a>
          <a href="registrer.html" class="nav-link auth-link"> Registrer </a>
          <div
            class="dropdown profile-link"
            id="settings-dropdown"
            style="display: none"
          >
            <a href="#" class="nav-link dropdown-toggle" id="settings-toggle">
              Logg ut
            </a>
            <div class="dropdown-menu">
              <a href="profil.html" class="dropdown-item"> Min profil </a>
              <a href="profil.html#change-password" class="dropdown-item">
                Endre passord
              </a>
              <a href="mailto:kontakt@sbs.no" class="dropdown-item">
                Kontakt oss
              </a>
              <a href="#" id="logout-link" class="dropdown-item danger">
                Logg ut
              </a>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <section class="hero hero-small">
      <h1>Sett nytt passord</h1>
      <p>Velg et nytt passord for kontoen din.</p>
    </section>

    <div class="container">
      <div class="card">
        <div id="reset-state">
          <p>Laster...</p>
        </div>

        <form id="new-password-form" style="display: none">
          <label for="new-password">Nytt passord:</label>
          <div class="password-field">
            <input
              type="password"
              id="new-password"
              name="new-password"
              required
              minlength="6"
            />
            <button
              type="button"
              class="password-toggle"
              data-target="new-password"
            >
              <img src="images/eye-open.png" alt="Vis passord" />
            </button>
          </div>

          <label for="confirm-password">Bekreft nytt passord:</label>
          <div class="password-field">
            <input
              type="password"
              id="confirm-password"
              name="confirm-password"
              required
              minlength="6"
            />
            <button
              type="button"
              class="password-toggle"
              data-target="confirm-password"
            >
              <img src="images/eye-open.png" alt="Vis passord" />
            </button>
          </div>

          <button type="submit" class="btn">Lagre nytt passord</button>
        </form>

        <div
          id="new-password-message"
          style="margin-top: var(--space-md)"
        ></div>
      </div>
    </div>

    <footer>
      <p>
        © 2025 SBS – Stabæk Bandy Support |
        <a href="personvern.html">Personvernerklæring</a>
      </p>
      <div class="footer-links">
        <a href="eilertmyr@gmail.com">
          <img src="images/mail.png" alt="Email-logo" class="logo" /> Kontakt
          oss
        </a>
        <a
          href="https://www.instagram.com/stabaek.klakken"
          target="_blank"
          rel="noopener noreferrer"
        >
          <img src="images/instagram.png" alt="Instagram-logo" class="logo" />
          Instagram
        </a>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="common.js"></script>
    <script>
      // Bruker nå 'supa' fra common.js

      const resetState = document.getElementById("reset-state");
      const form = document.getElementById("new-password-form");
      const msg = document.getElementById("new-password-message");

      // Når Supabase-linken åpnes, kommer det et access_token i URL-hashen
      async function initReset() {
        if (!supa) {
          resetState.innerHTML =
            '<p style="color:red;">Kunne ikke laste Supabase. Vennligst sjekk nettverket ditt.</p>';
          return;
        }

        const hash = window.location.hash;

        if (!hash || !hash.includes("type=recovery")) {
          resetState.innerHTML =
            '<p style="color:red;">Ugyldig eller utløpt lenke for tilbakestilling av passord.</p>';
          return;
        }

        // Supabase håndterer session automatisk fra URL-hashen
        const {
          data: { session },
          error,
        } = await supa.auth.getSession();

        if (error || !session) {
          resetState.innerHTML =
            '<p style="color:red;">Kunne ikke verifisere tilbakestillingslenken. Prøv å åpne lenken på nytt.</p>';
          return;
        }

        // Alt ok – vis skjema for nytt passord
        resetState.style.display = "none";
        form.style.display = "block";
      }

      async function setNewPassword(event) {
        event.preventDefault();

        if (!supa) {
          msg.innerHTML =
            '<p style="color:red;">Feil: Supabase er ikke tilgjengelig.</p>';
          return;
        }

        const newPassword = document.getElementById("new-password").value;
        const confirmPassword =
          document.getElementById("confirm-password").value;

        if (newPassword !== confirmPassword) {
          msg.innerHTML = '<p style="color:red;">Passordene matcher ikke.</p>';
          return;
        }

        if (newPassword.length < 6) {
          msg.innerHTML =
            '<p style="color:red;">Passordet må være minst 6 tegn.</p>';
          return;
        }

        const { error } = await supa.auth.updateUser({ password: newPassword });

        if (error) {
          msg.innerHTML =
            '<p style="color:red;">Feil ved lagring av nytt passord: ' +
            error.message +
            "</p>";
        } else {
          msg.innerHTML =
            '<p style="color:green;">Passordet er oppdatert! Du kan nå <a href="Inlogging.html">logge inn her</a>.</p>';
          form.reset();
          form.style.display = "none";
        }
      }

      form.addEventListener("submit", setNewPassword);
      initReset();
      // initDropdown og initPasswordToggles kjøres fra common.js
    </script>
  </body>
</html>
