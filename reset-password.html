<!DOCTYPE html>
<html lang="no">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sett nytt passord – SBS</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <div class="header-content">
        <img src="logo-placeholder.png" alt="SBS Logo" />
        <nav id="main-nav">
          <a href="index.html" class="nav-link"> Hjem </a>
          <a href="sanger.html" class="nav-link"> Sanger </a>
          <a href="betaling.html" class="nav-link"> Betaling </a>
          <a href="Inlogging.html" class="nav-link auth-link"> Logg inn </a>
          <a href="registrer.html" class="nav-link auth-link"> Registrer </a>
          <div
            class="dropdown profile-link"
            id="settings-dropdown"
            style="display: none"
          >
            <a href="#" class="nav-link dropdown-toggle" id="settings-toggle"
              > Logg ut </a
            >
            <div class="dropdown-menu">
              <a href="profil.html" class="dropdown-item"> Min profil </a>
              <a href="profil.html#change-password" class="dropdown-item"
                > Endre passord </a
              >
              <a href="mailto:kontakt@sbs.no" class="dropdown-item"
                > Kontakt oss </a
              >
              <a href="#" id="logout-link" class="dropdown-item danger"
                > Logg ut </a
              >
            </div>
          </div>
        </nav>
      </div>
    </header>

    <section class="hero hero-small">
      <h1>Sett nytt passord</h1>
      <p>Velg et nytt passord for kontoen din.</p>
    </section>

    <div class="container">
      <div class="card">
        <div id="reset-state">
          <p>Laster...</p>
        </div>

        <form id="new-password-form" style="display: none">
          <label for="new-password">Nytt passord:</label>
          <div class="password-field">
            <input
              type="password"
              id="new-password"
              name="new-password"
              required
              minlength="6"
            />
            <button
              type="button"
              class="password-toggle"
              data-target="new-password"
            >
              <img src="images/eye-open.png" alt="Vis passord" />
            </button>
          </div>

          <label for="confirm-password">Bekreft nytt passord:</label>
          <div class="password-field">
            <input
              type="password"
              id="confirm-password"
              name="confirm-password"
              required
              minlength="6"
            />
            <button
              type="button"
              class="password-toggle"
              data-target="confirm-password"
            >
              <img src="images/eye-open.png" alt="Vis passord" />
            </button>
          </div>

          <button type="submit" class="btn">Lagre nytt passord</button>
        </form>

        <div
          id="new-password-message"
          style="margin-top: var(--space-md)"
        ></div>
      </div>
    </div>

    <footer>
      <p>SBS – Stabæk Bandy Support</p>
      <div class="footer-links">
        <a href="mailto:kontakt@sbs.no">
          <img src="images/mail.png" alt="Email-logo" class="logo" />
          Kontakt oss
        </a>
        <a
          href="https://www.instagram.com/stabaek.klakken"
          target="_blank"
          rel="noopener noreferrer"
        >
          <img src="images/instagram.png" alt="Instagram-logo" class="logo" />
          Instagram
        </a>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      const supa = supabase.createClient(
        "https://mqkoeaswvafrhyyotpqh.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xa29lYXN3dmFmcmh5eW90cHFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1ODMzMDAsImV4cCI6MjA4MDE1OTMwMH0.wQAcQFlUp77_46ycqfB--ywEN7uL5hRK0TdAy2PWkQs"
      );

      const resetState = document.getElementById("reset-state");
      const form = document.getElementById("new-password-form");
      const msg = document.getElementById("new-password-message");

      // Når Supabase-linken åpnes, kommer det et access_token i URL-hashen (#...)
      async function initReset() {
        const hash = window.location.hash; // f.eks. #access_token=...&type=recovery

        if (!hash || !hash.includes("type=recovery")) {
          resetState.innerHTML =
            '<p style="color:red;">Ugyldig eller utløpt lenke for tilbakestilling av passord.</p>';
          return;
        }

        // Supabase v2 håndterer session automatisk fra URL-hashen
        const {
          data: { session },
          error,
        } = await supa.auth.getSession();

        if (error || !session) {
          resetState.innerHTML =
            '<p style="color:red;">Kunne ikke verifisere tilbakestillingslenken. Prøv å åpne lenken på nytt.</p>';
          return;
        }

        // Alt ok – vis skjema for nytt passord
        resetState.style.display = "none";
        form.style.display = "block";
      }

      async function setNewPassword(event) {
        event.preventDefault();

        const newPassword = document.getElementById("new-password").value;
        const confirmPassword =
          document.getElementById("confirm-password").value;

        if (newPassword !== confirmPassword) {
          msg.innerHTML = '<p style="color:red;">Passordene matcher ikke.</p>';
          return;
        }

        if (newPassword.length < 6) {
          msg.innerHTML =
            '<p style="color:red;">Passordet må være minst 6 tegn.</p>';
          return;
        }

        const { error } = await supa.auth.updateUser({ password: newPassword });

        if (error) {
          msg.innerHTML =
            '<p style="color:red;">Feil ved lagring av nytt passord: ' +
            error.message +
            "</p>";
        } else {
          msg.innerHTML =
            '<p style="color:green;">Passordet er oppdatert! Du kan nå <a href="Inlogging.html">logge inn her</a>.</p>';
          form.reset();
          form.style.display = "none";
        }
      }

      // Vis/skjul passord-knapper
      function initPasswordToggles() {
        document.querySelectorAll(".password-toggle").forEach((btn) => {
          const targetId = btn.getAttribute("data-target");
          const input = document.getElementById(targetId);
          if (!input) return;

          btn.addEventListener("click", () => {
            const isPassword = input.type === "password";
            input.type = isPassword ? "text" : "password";
            const img = btn.querySelector("img");
            if (img) {
              img.src = isPassword
                ? "images/eye-close.png"
                : "images/eye-open.png";
              img.alt = isPassword ? "Skjul passord" : "Vis passord";
            }
          });
        });
      }

      // Dropdown funksjonalitet
      function initDropdown() {
        const dropdown = document.getElementById("settings-dropdown");
        const toggle = document.getElementById("settings-toggle");

        if (toggle) {
          toggle.addEventListener("click", (e) => {
            e.preventDefault();
            dropdown?.classList.toggle("active");
          });
        }

        // Lukk dropdown når man klikker utenfor
        document.addEventListener("click", (e) => {
          if (dropdown && !dropdown.contains(e.target)) {
            dropdown.classList.remove("active");
          }
        });

        // Logg ut funksjonalitet
        const logoutLink = document.getElementById("logout-link");
        if (logoutLink) {
          logoutLink.addEventListener("click", async (e) => {
            e.preventDefault();
            const { error } = await supa.auth.signOut();
            if (!error) {
              window.location.href = "index.html";
            }
          });
        }
      }

      form.addEventListener("submit", setNewPassword);
      initReset();
      initDropdown();
      initPasswordToggles();
    </script>
  </body>
</html>
