<!DOCTYPE html>
<html lang="no">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Betaling – SBS</title>
    <link rel="stylesheet" href="style.css?v=2" />
  </head>
  <body>
    <header>
      <div class="header-content">
        <img
          src="logo-placeholder.png"
          alt="logo-placeholder.png"
          alt="SBS Logo"
        />
        <nav id="main-nav">
          <a href="index.html" class="nav-link"> Hjem </a>
          <a href="sanger.html" class="nav-link"> Sanger </a>
          <a href="betaling.html" class="nav-link active"> Betaling </a>
          <a href="Inlogging.html" class="nav-link auth-link"> Logg inn </a>
          <a href="registrer.html" class="nav-link auth-link"> Registrer </a>
          <div
            class="dropdown profile-link"
            id="settings-dropdown"
            style="display: none"
          >
            <a href="#" class="nav-link dropdown-toggle" id="settings-toggle">
              Innstillinger
            </a>
            <div class="dropdown-menu">
              <a href="profil.html" class="dropdown-item"> Min profil </a>
              <a href="profil.html#change-password" class="dropdown-item">
                Endre passord
              </a>
              <a href="mailto:kontakt@sbs.no" class="dropdown-item">
                Kontakt oss
              </a>
              <a href="#" id="logout-link" class="dropdown-item danger">
                Logg ut
              </a>
            </div>
          </div>
        </nav>
      </div>
    </header>
    <section class="hero hero-small">
      <h1>Betaling</h1>
      <p>Fullfør medlemskapet ditt på en trygg og enkel måte.</p>
    </section>
    <div class="container">
      <div class="card" id="payment-card">
        <h2>Fullfør medlemsskap</h2>
        <div id="payment-info">
          <p>Laster betalingsinformasjon...</p>
        </div>
        <div id="payment-form" style="display: none">
          <div
            style="
              background: rgba(77, 163, 255, 0.1);
              padding: var(--space-lg);
              border-radius: var(--radius-md);
              margin: var(--space-lg) 0;
            "
          >
            <h3 style="margin-top: 0">
              Medlemskap: <span id="membership-price"> ... </span>
            </h3>
            <p id="age-info" style="margin: 0; font-size: 0.9em"></p>
          </div>

          <h3>Velg betalingsmetode:</h3>
          <div class="payment-methods">
            <label>
              <input type="radio" name="payment" value="vipps" id="vipps-radio" checked />
              <img src="images/vipps.jpg" alt="Vipps-logo" class="logo" />
              Vipps
            </label>
            <label>
              <input type="radio" name="payment" value="credit-card" id="card-radio" />
              <img
                src="images/credit-card.png"
                alt="Kredittkort-logo"
                class="logo"
              />
              Kredittkort
            </label>
          </div>

          <div
            id="card-form"
            style="display: none; margin-top: var(--space-lg)"
          >
            <h4>Kortbetaling</h4>
            <p class="muted-text">
              Kortbetaling vil bli implementert med Stripe eller lignende
              betalingsløsning.
            </p>
            <div
              style="
                background: rgba(0, 0, 0, 0.05);
                padding: var(--space-lg);
                border-radius: var(--radius-md);
                margin-top: var(--space-md);
              "
            >
              <p>
                <strong>Testmodus:</strong> Kortbetaling er ikke aktivert ennå.
                Kontakt oss for å fullføre betalingen.
              </p>
              <a
                href="mailto:kontakt@sbs.no"
                class="btn"
                style="margin-top: var(--space-md)"
                >Kontakt SBS</a
              >
            </div>
          </div>

          <div
            id="vipps-form"
            style="margin-top: var(--space-lg)"
          >
            <h4>Vipps-betaling</h4>
            <p class="muted-text">
              Vipps-betaling vil bli implementert med Vipps API.
            </p>
            <div
              style="
                background: rgba(0, 0, 0, 0.05);
                padding: var(--space-lg);
                border-radius: var(--radius-md);
                margin-top: var(--space-md);
              "
            >
              <p>
                <strong>Testmodus:</strong> Vipps-betaling er ikke aktivert
                ennå. Kontakt oss for å fullføre betalingen.
              </p>
              <a
                href="mailto:kontakt@sbs.no"
                class="btn"
                style="margin-top: var(--space-md)"
                >Kontakt SBS</a
              >
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="common.js"></script>
    <script>
      // Bruker nå 'supa' og 'calculateMembershipDetails()' fra common.js

      // Hovedfunksjon for å laste betalingsinformasjon
      async function loadPaymentInfo() {
        if (!supa) {
          document.getElementById("payment-info").innerHTML =
            '<p style="color: red;">Kunne ikke laste betalingsinformasjon (Supabase init feilet).</p>';
          return;
        }

        const { data: { session } } = await supa.auth.getSession();

        if (!session) {
          document.getElementById("payment-info").innerHTML =
            '<p>Du må være innlogget for å betale. <a href="Inlogging.html">Logg inn her</a>.</p>';
          return;
        }

        const { data: memberData, error } = await supa
          .from("members")
          .select("membership_price, membership_status, birthdate") // Henter fødselsdato
          .eq("auth_id", session.user.id)
          .maybeSingle();

        if (error) {
          console.error("FEIL VED HENTING AV MEDLEMSDATA:", error);
          document.getElementById("payment-info").innerHTML =
            '<p style="color: red;">FEIL: Kunne ikke laste medlemsinformasjon. Sjekk konsollen for detaljer.</p>';
          return;
        }

        if (!memberData) {
          document.getElementById("payment-info").innerHTML = `
            <div style="background: rgba(255, 165, 0, 0.1); padding: var(--space-lg); border-radius: var(--radius-md);">
              <h3 style="color: orange; margin-top: 0;">⚠️ Mangler medlemsdata</h3>
              <p>Din konto er opprettet, men vi finner ingen medlemsinformasjon. Kontakt oss for å fullføre registreringen.</p>
              <a href="mailto:kontakt@sbs.no" class="btn" style="margin-top: var(--space-md);">Kontakt SBS</a>
            </div>
          `;
          document.getElementById("payment-form").style.display = "none";
          return;
        }

        // Beregn detaljer for å få oppdatert aldersinformasjon
        const membershipDetails = calculateMembershipDetails(memberData.birthdate);
        
        // Bruk pris fra DB som fallback, men den skal i prinsippet matche den kalkulerte prisen
        const price = memberData.membership_price || membershipDetails.price;
        const membershipStatus = memberData.membership_status || "pending";

        // Vis pris og aldersinfo
        document.getElementById("membership-price").textContent =
          price.toFixed(2) + " kr";
        document.getElementById("age-info").textContent = membershipDetails.ageInfo;


        if (membershipStatus === "active" || membershipStatus === "paid") {
          document.getElementById("payment-info").innerHTML = `
            <div style="background: rgba(0, 200, 0, 0.1); padding: var(--space-lg); border-radius: var(--radius-md);">
              <h3 style="color: green; margin-top: 0;">✅ Medlemskap aktivt</h3>
              <p>Ditt medlemskap er allerede betalt og aktivt. Takk for at du støtter SBS!</p>
            </div>
          `;
          document.getElementById("payment-form").style.display = "none";
        } else {
          document.getElementById("payment-info").style.display = "none";
          document.getElementById("payment-form").style.display = "block";
          
          // Sikrer at Vipps er valgt som default ved lasting av skjema
          document.getElementById("vipps-form").style.display = "block";
          document.getElementById("card-form").style.display = "none";
        }
      }

      // Håndter bytte av betalingsmetode
      document.querySelectorAll('input[name="payment"]').forEach(radio => {
        radio.addEventListener('change', (event) => {
          if (event.target.value === 'vipps') {
            document.getElementById("vipps-form").style.display = "block";
            document.getElementById("card-form").style.display = "none";
          } else if (event.target.value === 'credit-card') {
            document.getElementById("vipps-form").style.display = "none";
            document.getElementById("card-form").style.display = "block";
          }
        });
      });

      // Oppstart
      loadPaymentInfo();
      if (supa) {
        supa.auth.onAuthStateChange(() => {
          loadPaymentInfo();
        });
      }
    </script>
    <footer>
      <p>SBS – Stabæk Bandy Support</p>
      <div class="footer-links">
        <a href="mailto:kontakt@sbs.no">
          <img src="images/mail.png" alt="Email-logo" class="logo" /> Kontakt
          oss
        </a>
        <a
          href="https://www.instagram.com/stabaek.klakken"
          target="_blank"
          rel="noopener noreferrer"
        >
          <img src="images/instagram.png" alt="Instagram-logo" class="logo" />
          Instagram
        </a>
      </div>
    </footer>
  </body>
</html>