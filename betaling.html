<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Betaling ‚Äì SBS</title>
<link rel="stylesheet" href="style.css?v=2">
</head>
<body>
<header>
  <div class="header-content">
    <img src="logo-placeholder.png" alt="logo-placeholder.png" alt="SBS Logo" />
    <nav id="main-nav">
      <a href="index.html" class="nav-link">Hjem</a>
      <a href="sanger.html" class="nav-link">Sanger</a>
      <a href="betaling.html" class="nav-link active">Betaling</a>
      <a href="Inlogging.html" class="nav-link auth-link">Logg inn</a>
      <a href="registrer.html" class="nav-link auth-link">Registrer</a>
      <div class="dropdown profile-link" id="settings-dropdown" style="display: none;">
        <a href="#" class="nav-link dropdown-toggle" id="settings-toggle">Innstillinger</a>
        <div class="dropdown-menu">
          <a href="profil.html" class="dropdown-item">Min profil</a>
          <a href="profil.html#change-password" class="dropdown-item">Endre passord</a>
          <a href="mailto:kontakt@sbs.no" class="dropdown-item">Kontakt oss</a>
          <a href="#" id="logout-link" class="dropdown-item danger">Logg ut</a>
        </div>
      </div>
    </nav>
  </div>
</header>
<section class="hero hero-small">
  <h1>Betaling</h1>
  <p>Fullf√∏r medlemskapet ditt p√• en trygg og enkel m√•te.</p>
</section>
<div class="container">
  <div class="card" id="payment-card">
    <h2>Fullf√∏r medlemsskap</h2>
    <div id="payment-info">
      <p>Laster betalingsinformasjon...</p>
    </div>
    <div id="payment-form" style="display: none;">
      <div style="background: rgba(77, 163, 255, 0.1); padding: var(--space-lg); border-radius: var(--radius-md); margin: var(--space-lg) 0;">
        <h3 style="margin-top: 0;">Medlemskap: <span id="membership-price">199 kr</span></h3>
        <p id="age-info" style="margin: 0; font-size: 0.9em;"></p>
      </div>
      
      <h3>Velg betalingsmetode:</h3>
      <div class="payment-methods">
        <label>
          <input type="radio" name="payment" value="vipps" checked>
          <img src="images/vipps.jpg" alt="Vipps-logo" class="logo">
          Vipps
        </label>
        <label>
          <input type="radio" name="payment" value="credit-card">
          <img src="images/credit-card.png" alt="Kredittkort-logo" class="logo">
          Kredittkort
        </label>
      </div>
      
      <div id="card-form" style="display: none; margin-top: var(--space-lg);">
        <h4>Kortbetaling</h4>
        <p class="muted-text">Kortbetaling vil bli implementert med Stripe eller lignende betalingsl√∏sning.</p>
        <div style="background: rgba(0, 0, 0, 0.05); padding: var(--space-lg); border-radius: var(--radius-md); margin-top: var(--space-md);">
          <p><strong>Testmodus:</strong> Kortbetaling er ikke aktivert enn√•. Kontakt oss for √• fullf√∏re betalingen.</p>
          <a href="mailto:kontakt@sbs.no" class="btn" style="margin-top: var(--space-md);">Kontakt SBS</a>
        </div>
      </div>
      
      <div id="vipps-form" style="display: none; margin-top: var(--space-lg);">
        <h4>Vipps-betaling</h4>
        <p class="muted-text">Vipps-betaling vil bli implementert med Vipps API.</p>
        <div style="background: rgba(0, 0, 0, 0.05); padding: var(--space-lg); border-radius: var(--radius-md); margin-top: var(--space-md);">
          <p><strong>Testmodus:</strong> Vipps-betaling er ikke aktivert enn√•. Kontakt oss for √• fullf√∏re betalingen.</p>
          <a href="mailto:kontakt@sbs.no" class="btn" style="margin-top: var(--space-md);">Kontakt SBS</a>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // Robust Supabase-init for √• unng√• feil ved lasting
  let supa = null;
  if (window.supabase) {
    const { createClient } = supabase;
    supa = createClient(
      "https://mqkoeaswvafrhyyotpqh.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xa29lYXN3dmFmcmh5eW90cHFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1ODMzMDAsImV4cCI6MjA4MDE1OTMwMH0.wQAcQFlUp77_46ycqfB--ywEN7uL5hRK0TdAy2PWkQs"
    );
  } else {
    console.error("Supabase-biblioteket ble ikke lastet.");
  }

  // Dropdown funksjonalitet
  function initDropdown() {
    const dropdown = document.getElementById('settings-dropdown');
    const toggle = document.getElementById('settings-toggle');
    
    if (toggle) {
      toggle.addEventListener('click', (e) => {
        e.preventDefault();
        dropdown?.classList.toggle('active');
      });
    }

    document.addEventListener('click', (e) => {
      if (dropdown && !dropdown.contains(e.target)) {
        dropdown.classList.remove('active');
      }
    });
  }

  // Oppdater navigasjon basert p√• innloggingsstatus
  async function updateNavigation() {
    const authLinks = document.querySelectorAll('.auth-link');
    const profileLinks = document.querySelectorAll('.profile-link');
    const logoutLink = document.getElementById('logout-link');

    if (!supa) {
      authLinks.forEach(link => link.style.display = 'block');
      profileLinks.forEach(link => link.style.display = 'none');
      initDropdown();
      return;
    }

    const { data: { session } } = await supa.auth.getSession();

    if (session) {
      authLinks.forEach(link => link.style.display = 'none');
      profileLinks.forEach(link => link.style.display = 'block');
    } else {
      authLinks.forEach(link => link.style.display = 'block');
      profileLinks.forEach(link => link.style.display = 'none');
    }

    if (logoutLink) {
      logoutLink.addEventListener('click', async (e) => {
        e.preventDefault();
        const { error } = await supa.auth.signOut();
        if (!error) {
          window.location.href = "index.html";
        }
      });
    }

    initDropdown();
  }

  // Hovedfunksjon for √• laste betalingsinformasjon og h√•ndtere feil/manglende rader
  async function loadPaymentInfo() {
    if (!supa) {
      document.getElementById('payment-info').innerHTML = '<p style="color: red;">Kunne ikke laste betalingsinformasjon (Supabase init feilet).</p>';
      return;
    }

    const { data: { session } } = await supa.auth.getSession();
    
    if (!session) {
      document.getElementById('payment-info').innerHTML = '<p>Du m√• v√¶re innlogget for √• betale. <a href="Inlogging.html">Logg inn her</a>.</p>';
      return;
    }
    console.log("Innlogget bruker UID:", session.user.id);
    // Hent medlemsdata - Bruker .limit(1) og .maybeSingle() for √• omg√• 406-feil fra PostgREST
    const { data: memberData, error } = await supa
      .from("members")
      .select("*")
      .eq("auth_id", session.user.id)
      .limit(1) // Sikrer at maksimalt √©n rad returneres fra databasen
      .maybeSingle({ // Tolker 0 rader som null (uten feil) og √©n rad som data.
          headers: { 
              'Accept': 'application/json', // Tvinger JSON
              'Prefer': 'return=representation' // Standard preferanse
          }
      });
    
    // 1. H√•ndter alvorlige feil (RLS-feil, network errors, men IKKE PGRST116)
    // Med .maybeSingle() er PGRST116 (0 rader) n√• h√•ndtert automatisk, og gir null data.
    if (error) {
      console.error("FEIL VED HENTING AV MEDLEMSDATA:", error);
      document.getElementById('payment-info').innerHTML = '<p style="color: red;">FEIL: Kunne ikke laste medlemsinformasjon. Sjekk konsollen for detaljer (sannsynligvis RLS-feil, dvs. 403).</p>';
      return;
    }
    
    // 2. H√•ndter manglende rad (memberData er null)
    if (!memberData) {
      document.getElementById('payment-info').innerHTML = `
        <div style="background: rgba(255, 165, 0, 0.1); padding: var(--space-lg); border-radius: var(--radius-md);">
          <h3 style="color: orange; margin-top: 0;">‚ö†Ô∏è Mangler medlemsdata</h3>
          <p>Din konto er opprettet, men vi finner ingen medlemsinformasjon. Vennligst pr√∏v √• logge ut og inn igjen, eller kontakt oss for √• fullf√∏re registreringen.</p>
          <a href="mailto:kontakt@sbs.no" class="btn" style="margin-top: var(--space-md);">Kontakt SBS</a>
        </div>
      `;
      document.getElementById('payment-form').style.display = 'none';
      return;
    }
    
    // 3. Alt OK: Vis betalingsskjema/status
    const price = memberData.membership_price || 199.00;
    const membershipStatus = memberData.membership_status || 'pending';

    document.getElementById('membership-price').textContent = price.toFixed(2) + ' kr';
    document.getElementById('age-info').textContent = 'Ordin√¶rt medlemskap for SBS.';

    if (membershipStatus === 'active' || membershipStatus === 'paid') {
      document.getElementById('payment-info').innerHTML = `
        <div style="background: rgba(0, 200, 0, 0.1); padding: var(--space-lg); border-radius: var(--radius-md);">
          <h3 style="color: green; margin-top: 0;">‚úÖ Medlemskap aktivt</h3>
          <p>Ditt medlemskap er allerede betalt og aktivt. Takk for at du st√∏tter SBS!</p>
        </div>
      `;
      document.getElementById('payment-form').style.display = 'none';
    } else {
      document.getElementById('payment-info').style.display = 'none';
      document.getElementById('payment-form').style.display = 'block';
    }
  }

  // Betalingsmetode-knapper
  document.getElementById('card-payment-btn')?.addEventListener('click', () => {
    document.getElementById('card-form').style.display = 'block';
    document.getElementById('vipps-form').style.display = 'none';
  });

  document.getElementById('vipps-payment-btn')?.addEventListener('click', () => {
    document.getElementById('vipps-form').style.display = 'block';
    document.getElementById('card-form').style.display = 'none';
  });

  // Oppstart
  updateNavigation();
  if (supa) {
    loadPaymentInfo();
    // Re-load n√•r autentiseringsstatus endres (f.eks. ved utlogging/innlogging)
    supa.auth.onAuthStateChange(() => {
      updateNavigation();
      loadPaymentInfo();
    });
  }
</script>
<footer>
  <p>SBS ‚Äì Stab√¶k Bandy Support</p>
  <div class="footer-links">
    <a href="mailto:kontakt@sbs.no">
      <span>üìß</span> Kontakt oss
    </a>
    <a href="https://www.instagram.com/stabaekbandy" target="_blank" rel="noopener noreferrer">
      <span>üì∑</span> Instagram
    </a>
  </div>
</footer>
</body>
</html>